#!/usr/bin/env python3
"""
ULTRATHINK LAYER 5 - SYNTHESIS VERIFICATION
Test the comprehensive AI story generation fix.
"""

import asyncio
import sys
import logging
from pathlib import Path

# Setup path
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root / "src"))

# Setup logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

async def test_complete_ai_story_fix():
    """
    Test the complete AI story generation workflow after the fix.
    This should now work end-to-end without fallback messages.
    """
    print("üöÄ ULTRATHINK LAYER 5 - SYNTHESIS VERIFICATION")
    print("=" * 70)
    print("Testing Complete AI Story Generation Fix...")
    print()
    
    success_count = 0
    total_tests = 4
    
    # TEST 1: GameManager with Fixed Agent Registration
    print("üéÆ TEST 1: GameManager with Fixed Agent Registration")
    print("-" * 50)
    try:
        from core.game_manager import GameManager
        
        game_manager = GameManager()
        success = await game_manager.initialize()
        
        if success:
            print(f"‚úÖ GameManager initialized successfully")
            print(f"   Status: {game_manager.status.value}")
            
            # Check agent system health
            agent_health = game_manager.system_health.get("agents", {})
            print(f"   Agent status: {agent_health.get('status', 'unknown')}")
            print(f"   Registered agents: {agent_health.get('registered_count', 0)}")
            
            if agent_health.get("registered_count", 0) > 0:
                print(f"   Agent names: {agent_health.get('agents', [])}")
                success_count += 1
                print("‚úÖ AGENTS SUCCESSFULLY REGISTERED!")
            else:
                print("‚ùå No agents registered")
                
            # Verify story agent is accessible
            if game_manager.agent_manager:
                story_agent = game_manager.agent_manager.get_agent("story_agent")
                if story_agent:
                    print("‚úÖ StoryAgent is accessible via AgentManager")
                else:
                    print("‚ùå StoryAgent not accessible via AgentManager")
        else:
            print("‚ùå GameManager initialization failed")
            
        await game_manager.shutdown()
        
    except Exception as e:
        print(f"‚ùå GameManager test failed: {e}")
    
    print()
    
    # TEST 2: End-to-End GameplayController Test
    print("üéØ TEST 2: End-to-End GameplayController Test")
    print("-" * 50)
    try:
        from core.game_manager import GameManager
        from core.gameplay_controller import GameplayController
        from core.game_engine import GameEngine, Character
        
        # Initialize complete system
        game_manager = GameManager()
        await game_manager.initialize()
        
        # Create character and start game engine
        character = Character(
            name="Ï°∞ÏÇ¨Í¥Ä",
            age=30,
            occupation="investigator",
            residence="Arkham, Massachusetts",
            characteristics={
                "strength": 60, "constitution": 70, "power": 65,
                "dexterity": 55, "appearance": 50, "size": 60,
                "intelligence": 75, "education": 80
            }
        )
        
        game_manager.game_engine.character = character
        game_manager.game_engine.current_scene = "library_entrance"
        
        # Create gameplay controller
        controller = GameplayController(
            game_manager.game_engine,
            game_manager.agent_manager,
            scenario=None
        )
        
        # Test player action processing
        print("   Testing player action: 'Ïò§ÎûòÎêú Ï±ÖÏùÑ Ï°∞ÏÇ¨ÌïúÎã§'")
        
        turn_result = await controller.process_player_action("Ïò§ÎûòÎêú Ï±ÖÏùÑ Ï°∞ÏÇ¨ÌïúÎã§")
        
        print(f"   Turn success: {turn_result.success}")
        print(f"   Story text: {turn_result.story_content.text[:100]}...")
        print(f"   Investigation opportunities: {len(turn_result.story_content.investigation_opportunities)}")
        
        # Check if it's NOT the generic fallback message
        generic_fallback = "ÎãπÏã†Ïùò ÌñâÎèôÏù¥ ÏÉÅÌô©Ïóê Î≥ÄÌôîÎ•º Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§."
        if generic_fallback not in turn_result.story_content.text:
            success_count += 1
            print("‚úÖ RICH AI STORY CONTENT GENERATED (NOT FALLBACK)!")
        else:
            print("‚ùå Still getting generic fallback message")
            
        await game_manager.shutdown()
        
    except Exception as e:
        print(f"‚ùå End-to-end test failed: {e}")
        import traceback
        traceback.print_exc()
    
    print()
    
    # TEST 3: Multiple Story Generation Test
    print("üìö TEST 3: Multiple Story Generation Test")
    print("-" * 50)
    try:
        from core.game_manager import GameManager
        from core.gameplay_controller import GameplayController
        from core.game_engine import Character
        
        game_manager = GameManager()
        await game_manager.initialize()
        
        character = Character(
            name="Ï°∞ÏÇ¨Í¥Ä", age=30, occupation="investigator",
            residence="Arkham", characteristics={
                "strength": 60, "constitution": 70, "power": 65,
                "dexterity": 55, "appearance": 50, "size": 60,
                "intelligence": 75, "education": 80
            }
        )
        
        game_manager.game_engine.character = character
        game_manager.game_engine.current_scene = "library_entrance"
        
        controller = GameplayController(
            game_manager.game_engine, game_manager.agent_manager
        )
        
        test_actions = [
            "Ï±ÖÏû•ÏùÑ ÏûêÏÑ∏Ìûà ÏÇ¥Ìé¥Î≥∏Îã§",
            "Î∞îÎã•Ïóê Îñ®Ïñ¥ÏßÑ Ï¢ÖÏù¥Î•º Ï°∞ÏÇ¨ÌïúÎã§",
            "Ï∞ΩÎ¨∏ Î∞ñÏùÑ Í¥ÄÏ∞∞ÌïúÎã§"
        ]
        
        ai_responses = 0
        
        for i, action in enumerate(test_actions, 1):
            print(f"   Action {i}: {action}")
            result = await controller.process_player_action(action)
            
            # Check if response is AI-generated (not fallback)
            fallback_messages = [
                "ÎãπÏã†Ïùò ÌñâÎèôÏù¥ ÏÉÅÌô©Ïóê Î≥ÄÌôîÎ•º Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§.",
                "ÏÉÅÌô©Ïù¥ Ï°∞Í∏àÏî© Ï†ÑÍ∞úÎêòÏñ¥ Í∞ÄÍ≥† ÏûàÏäµÎãàÎã§.",
                "ÎãπÏã†ÏùÄ Ïã†Ï§ëÌïòÍ≤å Îã§Ïùå ÌñâÎèôÏùÑ Í≥†Î†§Ìï¥Ïïº Ìï©ÎãàÎã§."
            ]
            
            is_ai_response = not any(fallback in result.story_content.text for fallback in fallback_messages)
            
            if is_ai_response:
                ai_responses += 1
                print(f"   ‚úÖ AI Response: {result.story_content.text[:60]}...")
            else:
                print(f"   ‚ùå Fallback: {result.story_content.text}")
        
        if ai_responses == len(test_actions):
            success_count += 1
            print("‚úÖ ALL ACTIONS GENERATED RICH AI CONTENT!")
        else:
            print(f"‚ùå Only {ai_responses}/{len(test_actions)} generated AI content")
            
        await game_manager.shutdown()
        
    except Exception as e:
        print(f"‚ùå Multiple story test failed: {e}")
    
    print()
    
    # TEST 4: Investigation Opportunity Generation
    print("üîç TEST 4: Investigation Opportunity Generation")
    print("-" * 50)
    try:
        from core.game_manager import GameManager
        from core.gameplay_controller import GameplayController
        from core.game_engine import Character
        
        game_manager = GameManager()
        await game_manager.initialize()
        
        character = Character(
            name="Ï°∞ÏÇ¨Í¥Ä", age=30, occupation="investigator",
            residence="Arkham", characteristics={
                "strength": 60, "constitution": 70, "power": 65,
                "dexterity": 55, "appearance": 50, "size": 60,
                "intelligence": 75, "education": 80
            }
        )
        
        game_manager.game_engine.character = character
        game_manager.game_engine.current_scene = "library_entrance"
        
        controller = GameplayController(
            game_manager.game_engine, game_manager.agent_manager
        )
        
        result = await controller.process_player_action("ÎØ∏Ïä§Ïπ¥ÌÜ†Îãâ ÎåÄÌïôÍµê ÎèÑÏÑúÍ¥ÄÏóê Îì§Ïñ¥Í∞ÑÎã§")
        
        print(f"   Generated {len(result.story_content.investigation_opportunities)} investigation opportunities:")
        for i, opportunity in enumerate(result.story_content.investigation_opportunities[:3], 1):
            print(f"   {i}. {opportunity}")
        
        if len(result.story_content.investigation_opportunities) >= 3:
            success_count += 1
            print("‚úÖ INVESTIGATION OPPORTUNITIES GENERATED!")
        else:
            print("‚ùå Insufficient investigation opportunities")
            
        await game_manager.shutdown()
        
    except Exception as e:
        print(f"‚ùå Investigation test failed: {e}")
    
    print()
    print("üéØ SYNTHESIS VERIFICATION SUMMARY")
    print("=" * 50)
    print(f"Successful Tests: {success_count}/{total_tests}")
    print()
    
    if success_count == total_tests:
        print("üéâ COMPLETE SUCCESS!")
        print("‚úÖ AI Story Generation System FULLY OPERATIONAL")
        print("‚úÖ No more generic fallback messages")
        print("‚úÖ Rich Korean story content being generated")
        print("‚úÖ Investigation opportunities working")
        print()
        print("üèÜ THE ULTRATHINK ANALYSIS WAS SUCCESSFUL!")
        print("üîß The AI story generation issue has been RESOLVED!")
    elif success_count > 0:
        print("‚ö†Ô∏è  Partial Success - Some components working")
        print(f"   Fixed: {success_count} components")
        print(f"   Remaining issues: {total_tests - success_count} components")
    else:
        print("üö® All tests failed - Further investigation needed")
    
    return success_count == total_tests

if __name__ == "__main__":
    asyncio.run(test_complete_ai_story_fix())